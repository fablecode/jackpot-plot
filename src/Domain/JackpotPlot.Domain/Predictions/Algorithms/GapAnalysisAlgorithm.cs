using JackpotPlot.Domain.Domain;
using JackpotPlot.Domain.Models;
using JackpotPlot.Domain.ValueObjects;
using System.Collections.Immutable;
using JackpotPlot.Domain.Predictions.Helpers;
using JackpotPlot.Primitives.Algorithms;

namespace JackpotPlot.Domain.Predictions.Algorithms;

[PredictionAlgorithmDescription(PredictionAlgorithmKeys.GapAnalysis, "Analyzes the gaps between consecutive numbers in historical draws to identify recurring gap patterns. Predictions are generated by replicating these common spacing intervals.")]
public sealed class GapAnalysisAlgorithm : IPredictionAlgorithm
{
    public PredictionResult Predict(
        LotteryConfigurationDomain config,
        IReadOnlyList<HistoricalDraw> history,
        Random rng)
    {
        // 1) derive gap frequencies from history
        var gapFreq = GapAnalysisAlgorithmHelpers.AnalyzeGaps(history);

        // 2) choose up to (N-1) gaps for N main numbers
        var mainCount = config.MainNumbersCount;
        var neededGaps = Math.Max(0, mainCount - 1);
        var selectedGaps = GapAnalysisAlgorithmHelpers.SelectGaps(gapFreq, neededGaps);

        // 3) generate main numbers from gaps (respect range; start in lower half)
        var main = GapAnalysisAlgorithmHelpers.GenerateNumbersFromGaps(
            maxRange: config.MainNumbersRange,
            selectedGaps,
            targetCount: mainCount,
            rng).ToImmutableArray();

        // 4) bonus numbers (random, distinct from main)
        var bonus = config.BonusNumbersCount > 0
            ? GapAnalysisAlgorithmHelpers.RandomDistinct(1, config.BonusNumbersRange, main, config.BonusNumbersCount, rng)
            : ImmutableArray<int>.Empty;

        // 5) a simple confidence: how many predicted gaps match typical historical gaps
        var confidence = GapAnalysisAlgorithmHelpers.CalculateGapAnalysisConfidence(history, main.ToList());

        return new PredictionResult(
            config.LotteryId,
            main,
            bonus,
            confidence,
            PredictionAlgorithmKeys.GapAnalysis);
    }
}